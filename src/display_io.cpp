/**
 * display_io.cpp - SSD1306 OLED Display I2C implementation
 */

#include "display_io.h"
#include "spsc_queue.h"
#include "trace.h"
#include <Adafruit_SSD1306.h>
#include <Adafruit_GFX.h>
#include <TeensyThreads.h>
#include <Wire.h>

/**
 * HARDWARE CONFIGURATION
 */
static constexpr uint8_t DISPLAY_I2C_ADDR = 0x3C;  // Default SSD1306 address
static constexpr uint8_t DISPLAY_WIDTH = 128;
static constexpr uint8_t DISPLAY_HEIGHT = 64;
static constexpr int8_t RESET_PIN = -1;  // No reset pin (using I2C reset)

/**
 * THREAD TIMING
 */
static constexpr uint32_t IDLE_DELAY_MS = 50;  // Delay when queue empty (low CPU usage)

/**
 * SSD1306 Display object
 * Initialize with Wire1 bus (SDA1=pin 17, SCL1=pin 16)
 */
static Adafruit_SSD1306 display(DISPLAY_WIDTH, DISPLAY_HEIGHT, &Wire1, RESET_PIN);

/**
 * Lock-free command queue (App thread â†’ DisplayIO thread)
 */
static SPSCQueue<DisplayEvent, 16> commandQueue;

/**
 * Current display state
 */
static volatile BitmapID currentBitmap = BitmapID::DEFAULT;

// =============================================================================
// BITMAP STORAGE
// =============================================================================

/**
 * Bitmap structure for registry
 */
struct BitmapData {
    const uint8_t* data;  // Pointer to PROGMEM bitmap array
    uint16_t width;
    uint16_t height;
};

/**
 * Example bitmaps (LCDAssistant format: 128x64, horizontal bytes, LSB first)
 *
 * PLACEHOLDER BITMAPS - Replace these with your actual bitmaps from LCDAssistant!
 *
 * To create bitmaps:
 * 1. Design 128x64 image in image editor (white = on, black = off)
 * 2. Open in LCDAssistant
 * 3. Set: Byte orientation = Horizontal, Size = 128x64
 * 4. Generate source code
 * 5. Copy array here and update bitmap registry
 */

// Default/Idle bitmap (example: simple border frame)
static const uint8_t PROGMEM bitmap_default[1024] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x07, 0xC0, 0x00, 0xF8, 0x07, 0xF3, 0x80, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x0E, 0xE0, 0x03, 0xDC, 0x03, 0xFD, 0xC0, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x1C, 0x70, 0x07, 0x8E, 0x03, 0xF8, 0xE0, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x3C, 0x78, 0x07, 0x8F, 0x03, 0xF0, 0xF0, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x3C, 0x7C, 0x0F, 0x8F, 0x03, 0xF0, 0xF0, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x7C, 0x7C, 0x0F, 0x8F, 0x83, 0xF0, 0xF0, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x7C, 0x7C, 0x0F, 0x8F, 0x83, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0x7C, 0x7E, 0x1F, 0x8F, 0x83, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x00, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xFC, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x08, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x18, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x18, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x18, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x18, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x38, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x0F, 0x80, 0x0F, 0xE0, 0x38, 0xFC, 0x7E, 0x1F, 0x8F, 0xC3, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x1F, 0x80, 0x0F, 0xE0, 0x38, 0x7C, 0x7E, 0x1F, 0x8F, 0x83, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x3F, 0x84, 0x0F, 0xE0, 0x38, 0x7C, 0x7C, 0x0F, 0x8F, 0x83, 0xF0, 0xF8, 0x00,
    0x00, 0x0F, 0x80, 0x5F, 0x8C, 0x0F, 0xE0, 0x78, 0x7C, 0x7C, 0x0F, 0x8F, 0x83, 0xF0, 0xF0, 0x00,
    0x00, 0x0F, 0xC0, 0x8F, 0x88, 0x0F, 0xE0, 0x78, 0x3C, 0x7C, 0x0F, 0x8F, 0x03, 0xF0, 0xF0, 0x00,
    0x00, 0x0F, 0xE1, 0x8F, 0xD8, 0x0F, 0xE0, 0xF8, 0x3C, 0x78, 0x07, 0x8F, 0x03, 0xF8, 0xF0, 0x00,
    0x00, 0x0F, 0xFF, 0x0F, 0xF8, 0x0F, 0xE0, 0xF0, 0x1C, 0x78, 0x03, 0x8E, 0x03, 0xF9, 0xE0, 0x00,
    0x00, 0x0D, 0xFE, 0x07, 0xF0, 0x0F, 0xE3, 0xF0, 0x0E, 0xF0, 0x03, 0xDC, 0x03, 0xF7, 0xC0, 0x00,
    0x00, 0x0C, 0xF8, 0x03, 0xC0, 0x3F, 0xFF, 0xF0, 0x07, 0xC0, 0x00, 0xF8, 0x03, 0xF3, 0x80, 0x00,
    0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xF0, 0x00, 0x00,
    0x00, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFC, 0x00, 0x00,
};

// Choke active bitmap (example: large "MUTE" text or X symbol)
static const uint8_t PROGMEM bitmap_choke_active[1024] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xF8, 0x03, 0xFF, 0xCF, 0xFF, 0x00, 0x1F, 0x80, 0x0F, 0xFF, 0x87, 0xFE, 0x3F, 0xFF, 0xFF,
    0x03, 0x84, 0x20, 0x7F, 0x83, 0xFC, 0x00, 0x39, 0xE0, 0x03, 0xFC, 0x01, 0xF0, 0x0F, 0xF0, 0x7F,
    0x07, 0x82, 0x60, 0x7F, 0x83, 0xFC, 0x00, 0xF0, 0xF0, 0x03, 0xFC, 0x00, 0xE0, 0x0F, 0xF0, 0x3F,
    0x0F, 0x02, 0xE0, 0x7F, 0x83, 0xFC, 0x00, 0xF0, 0x78, 0x03, 0xFC, 0x00, 0xC0, 0x0F, 0xF0, 0x1F,
    0x0F, 0x01, 0xE0, 0x7F, 0x83, 0xFC, 0x01, 0xF0, 0x78, 0x03, 0xFC, 0x00, 0xC0, 0x0F, 0xF0, 0x1F,
    0x1F, 0x01, 0xE0, 0x7F, 0x83, 0xFC, 0x03, 0xF0, 0x7C, 0x03, 0xFC, 0x00, 0x80, 0x0F, 0xF0, 0x0F,
    0x1F, 0x00, 0xE0, 0x7F, 0x83, 0xFC, 0x03, 0xF0, 0x7C, 0x03, 0xFC, 0x00, 0x80, 0x0F, 0xF0, 0x0F,
    0x3F, 0x00, 0xE0, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7E, 0x03, 0xFC, 0x00, 0x80, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x60, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7E, 0x03, 0xFC, 0x01, 0x80, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x60, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7F, 0x03, 0xFC, 0x01, 0x00, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x60, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7F, 0x03, 0xFC, 0x03, 0x00, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x60, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x02, 0x00, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x02, 0x00, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x06, 0x00, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x04, 0x00, 0x0F, 0xF0, 0x23,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x0C, 0x00, 0x0F, 0xF0, 0x21,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x08, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x08, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x18, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x10, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x30, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0x30, 0x00, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0x78, 0x00, 0x0F, 0xF0, 0x60,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0x78, 0x00, 0x0F, 0xF0, 0x60,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0x78, 0x00, 0x0F, 0xF0, 0x60,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0xF8, 0x00, 0x0F, 0xF0, 0x60,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0xFC, 0x00, 0x0F, 0xF0, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0xFF, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFD, 0xFC, 0x00, 0x0F, 0xF1, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0xFF, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFF, 0xFC, 0x00, 0x0F, 0xF3, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFF, 0xFE, 0x00, 0x0F, 0xFF, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFF, 0xFE, 0x00, 0x0F, 0xF3, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFF, 0xFE, 0x00, 0x0F, 0xF1, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFF, 0xFE, 0x00, 0x0F, 0xF0, 0xE0,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFD, 0xFF, 0x00, 0x0F, 0xF0, 0x60,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFD, 0xFF, 0x00, 0x0F, 0xF0, 0x61,
    0xFF, 0x00, 0x00, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0xFF, 0x00, 0x0F, 0xF0, 0x61,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0xFF, 0x00, 0x0F, 0xF0, 0x61,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x1F, 0xF0, 0x7F, 0x83, 0xFC, 0xFF, 0x80, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x7F, 0x80, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x7F, 0x80, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x7F, 0x80, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x7F, 0xC0, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x3F, 0xC0, 0x0F, 0xF0, 0x21,
    0xFF, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x3F, 0xC0, 0x0F, 0xF0, 0x23,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x83, 0xFC, 0x3F, 0xC0, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x3F, 0xE0, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x1F, 0xE0, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x0F, 0xF0, 0x7F, 0x03, 0xFC, 0x1F, 0xE0, 0x0F, 0xF0, 0x03,
    0x7F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7F, 0x03, 0xFC, 0x1F, 0xE0, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x20, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7F, 0x03, 0xFC, 0x1F, 0xF0, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x60, 0x7F, 0x83, 0xFC, 0x07, 0xF0, 0x7E, 0x03, 0xFC, 0x0F, 0xF0, 0x0F, 0xF0, 0x07,
    0x3F, 0x00, 0x40, 0x7F, 0x83, 0xFC, 0x03, 0xF0, 0x7E, 0x03, 0xFC, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F,
    0x3F, 0x00, 0x40, 0x7F, 0x83, 0xFC, 0x03, 0xF0, 0x7E, 0x03, 0xFC, 0x0F, 0xF0, 0x0F, 0xF0, 0x0F,
    0x1F, 0x00, 0xC0, 0x7F, 0x83, 0xFC, 0x01, 0xF0, 0x7C, 0x03, 0xFC, 0x07, 0xF8, 0x0F, 0xF0, 0x1F,
    0x1F, 0x00, 0x80, 0x7F, 0x83, 0xFC, 0x01, 0xF0, 0x7C, 0x03, 0xFC, 0x07, 0xF8, 0x0F, 0xF0, 0x1F,
    0x0F, 0x01, 0x00, 0x7F, 0x83, 0xFC, 0x00, 0xF0, 0x78, 0x03, 0xFC, 0x07, 0xF8, 0x0F, 0xF0, 0x3F,
    0x07, 0x83, 0x00, 0x7F, 0x83, 0xFC, 0x00, 0x70, 0xF0, 0x03, 0xFC, 0x07, 0xFC, 0x0F, 0xF0, 0x7F,
    0x03, 0x84, 0x00, 0x7F, 0x83, 0xFC, 0x00, 0x38, 0xE0, 0x03, 0xFC, 0x03, 0xFC, 0x0F, 0xF0, 0xFF,
    0x01, 0xF8, 0x03, 0xFF, 0xCF, 0xFF, 0x80, 0x0F, 0x80, 0x0F, 0xFF, 0x9F, 0xFF, 0x3F, 0xFF, 0xFF,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

/**
 * Bitmap registry - maps BitmapID to actual bitmap data
 * Add new bitmaps here as you create them!
 */
static const BitmapData bitmapRegistry[] = {
    { bitmap_default, DISPLAY_WIDTH, DISPLAY_HEIGHT },        // BitmapID::DEFAULT
    { bitmap_choke_active, DISPLAY_WIDTH, DISPLAY_HEIGHT },   // BitmapID::CHOKE_ACTIVE
    // Add more bitmaps here as needed
};

static constexpr uint8_t NUM_BITMAPS = sizeof(bitmapRegistry) / sizeof(BitmapData);

// =============================================================================
// INTERNAL HELPERS
// =============================================================================

/**
 * Draw bitmap to display
 *
 * @param id Bitmap ID to draw
 */
static void drawBitmap(BitmapID id) {
    uint8_t index = static_cast<uint8_t>(id);

    // Bounds check
    if (index >= NUM_BITMAPS) {
        Serial.print("ERROR: Invalid bitmap ID: ");
        Serial.println(index);
        return;
    }

    const BitmapData& bitmap = bitmapRegistry[index];

    // Clear display buffer
    display.clearDisplay();

    // Draw bitmap (full screen, top-left origin)
    display.drawBitmap(0, 0, bitmap.data, bitmap.width, bitmap.height, WHITE);

    // Push to display
    display.display();

    // Update state
    currentBitmap = id;
}

// =============================================================================
// PUBLIC API
// =============================================================================

bool DisplayIO::begin() {
    // Initialize Wire1 (I2C bus 1: SDA1=pin 17, SCL1=pin 16)
    Wire1.begin();
    Wire1.setClock(400000);  // 400kHz I2C speed (fast mode)

    // Initialize SSD1306 display
    if (!display.begin(SSD1306_SWITCHCAPVCC, DISPLAY_I2C_ADDR)) {
        Serial.println("ERROR: SSD1306 display not detected on I2C!");
        return false;
    }

    // Clear display
    display.clearDisplay();
    display.display();

    // Show default bitmap
    drawBitmap(BitmapID::DEFAULT);

    Serial.println("DisplayIO: SSD1306 display initialized (I2C 0x3C on Wire1)");
    return true;
}

void DisplayIO::threadLoop() {
    /**
     * DISPLAY UPDATE STRATEGY:
     *
     * 1. Drain command queue
     * 2. Execute commands (bitmap switches)
     * 3. Sleep when idle (low CPU usage)
     *
     * PERFORMANCE:
     * - Full screen update: ~20-30ms (acceptable, not audio critical)
     * - Sleep 50ms when queue empty
     * - Thread priority: Lower than audio/MIDI
     */

    for (;;) {
        DisplayEvent event;
        bool hadWork = false;

        // Drain command queue
        while (commandQueue.pop(event)) {
            hadWork = true;

            switch (event.command) {
                case DisplayCommand::SHOW_DEFAULT:
                    drawBitmap(BitmapID::DEFAULT);
                    break;

                case DisplayCommand::SHOW_CHOKE:
                    drawBitmap(BitmapID::CHOKE_ACTIVE);
                    break;

                case DisplayCommand::SHOW_CUSTOM:
                    drawBitmap(event.bitmapID);
                    break;
            }
        }

        // Sleep when idle (reduce CPU usage)
        if (!hadWork) {
            threads.delay(IDLE_DELAY_MS);
        }
    }
}

void DisplayIO::showDefault() {
    DisplayEvent event(DisplayCommand::SHOW_DEFAULT);
    commandQueue.push(event);
}

void DisplayIO::showChoke() {
    DisplayEvent event(DisplayCommand::SHOW_CHOKE);
    commandQueue.push(event);
}

void DisplayIO::showBitmap(BitmapID id) {
    DisplayEvent event(DisplayCommand::SHOW_CUSTOM, id);
    commandQueue.push(event);
}

BitmapID DisplayIO::getCurrentBitmap() {
    return currentBitmap;
}
